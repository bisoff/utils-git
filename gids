#!/bin/bash
# shows menu to choose file which diff you want to view

# TODO: if total files > 9 -> wait second key

#put untracked fnames to arr
arr=($(git ls-files --others --exclude-standard)) # 
	#array=($(gis | grep -v '??' | cut -c 4-)) 
	#array=($({(git diff --stat=200 --color | sed -n '$! p'); for i in "${arr[@]}"; do echo -e " ${yellow}$i${norm}"; done;	} | awk '{print NR "\t" $0}' )) 

#put tracked fnames to array:
array=($({(git status -s --untracked-files --porcelain | grep -v '??' | cut -c 4-); for i in "${arr[@]}"; do echo "$i"; done;	})) 
(( tot = ${#array[@]} )) #; echo tot: $tot #+ ${#arr[@]}
[[ $tot -eq 0 ]] && echo "No files found" && exit #; for i in "${array[@]}"; do echo "$i"; done # echo "${array[@]}"
bound=${#array[@]} 
(( bound = bound - 1 )) #; echo bound: $bound

# show header with enumed file list:
{(git diff --stat=200 --color | sed -n '$! p'); for i in "${arr[@]}"; do echo -e " ${yellow}UNTRACKED: $i${norm}"; done;	} | awk '{print NR "\t" $0}' 

# show menu
current=0 # current index for view diff
init_prompt="${yellow}Press key with your choice${norm} - (${green}0..9${norm}-file_number  ${green}N${norm}-next  ${green}P${norm}:revious  ${green}<CR>${norm}-current  ${green}Q${norm}-quit: " 
looped_prompt="\n$init_prompt"
prompt_out=" ${yellow}Viewed #$(( current + 1 )) - '${array[$current]}'${norm} $looped_prompt"
fail_prompt=" ${red}$n is out of bounds (1..$(( bound + 1 )) ) !${norm} $looped_prompt"
(( num = current + 1 )) # echo num: $num
#gid "${array[$current]}"
echo -n -e "$init_prompt"
read -rsn1 n
echo -n -e "$n"
while true;	do
	#clear
	is_invalid=1 # unknown key pressed
	if [ "$n" == "Q" -o "$n" == "q" ]; then 
		echo "" #<CR>
		break
	  fi
	if [ "$n" == "C"  -o  "$n" == "c"  -o  "$n" == "" ]; then
		[ "$n" == "" ] && echo -n "<CR>"
		is_invalid=0
	  fi
	if [ "$n" == "N" -o "$n" == "n" ]; then
		if [ $current -lt $bound ]; then 
			(( current = current + 1 )) 
			is_invalid=0
		  else
		  	is_invalid=2 # out of bounds
		  fi
	  fi
	if [ "$n" == "P" -o "$n" == "p" ]; then
		if [ $current -gt 0 ]; then
			(( current = current - 1 ))
			is_invalid=0
		  else
		  	is_invalid=2 # out of bounds
		  fi
	  fi
	if [[ $n =~ ^[0-9]$ ]]; then #if [ "$var" -eq "$var" ] 2>/dev/null; then
		(( new_idx = n - 1 ))

		if [[ $new_idx -le $bound  &&  $new_idx -ge 0 ]]; then 
			(( current = new_idx )) 
			is_invalid=0
		  else
		  	is_invalid=2 # out of bounds
		  fi
	  fi
	if [ $is_invalid -eq 2 ]; then
	  	echo -n -e "$fail_prompt"
		read -rsn1 n
		echo -n -e "$n"
		continue
	  fi
	if [ ! $is_invalid -eq 0 ]; then
		echo -n -e " ${red}'$n' is not valid choice !${norm} $looped_prompt"
		read -rsn1 n
		echo -n -e "$n"
		continue
	  fi
	if [ -f "${array[$current]}" ]; then
		gid "${array[$current]}"
		echo -n -e "$prompt_out"  #$(( current + 1 ))
	  else
	  	echo -e " ${yellow}File (#$(( current + 1 ))) not found (deleted?) - '${array[$current]}'${norm}"
		echo -n -e "$init_prompt"
	  fi
	read -rsn1 n
	echo -n -e "$n"
  done
